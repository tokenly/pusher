// Generated by CoffeeScript 1.8.0

/*
 *
 * This server runs a Faye websocket messaging hub
 *
 */

(function() {
  var bayeux, client, faye, http, n, pusherHost, pusherPort, secret, server;

  pusherPort = process.env.PUSHER_PORT || 8200;

  pusherHost = process.env.PUSHER_HOST || "localhost";

  secret = process.env.PUSHER_PASSWORD || '';

  http = require('http');

  faye = require('faye');

  server = http.createServer();

  bayeux = new faye.NodeAdapter({
    mount: '/public'
  });

  if (secret.length > 0) {
    bayeux.addExtension({
      incoming: function(message, callback) {
        var password, _ref;
        if (!message.channel.match(/^\/meta\//)) {
          password = (_ref = message.ext) != null ? _ref.password : void 0;
          if (password !== secret) {
            message.error = '403::Password required';
          }
        }
        callback(message);
      },
      outgoing: function(message, callback) {
        if (message.ext) {
          delete message.ext.password;
        }
        callback(message);
      }
    });
  }

  console.log("starting server on port " + pusherPort);

  bayeux.attach(server);

  server.listen(pusherPort);

  bayeux.on('subscribe', function(clientId, channel) {
    return console.log('[SUBSCRIBE] ' + clientId + ' -> ' + channel);
  });

  console.log("subscribing to http://localhost:" + pusherPort + "/public");

  client = new faye.Client("http://localhost:" + pusherPort + "/public");

  n = 0;

  setInterval(function() {
    var res;
    res = client.publish('/tick', {
      ts: Date.now()
    });
  }, 30000);

}).call(this);
